{
    "sourceFile": "controllers/emailController.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1769550561265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769550913827,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,9 +57,9 @@\n           (error, result) => {\n             if (error) reject(error);\n             else\n               resolve({\n-                url: result.imageUrl, //getPngUrl(result.public_id),\n+                url: result., //getPngUrl(result.public_id),\n                 publicId: result.public_id,\n               });\n           }\n         );\n"
                },
                {
                    "date": 1769550984465,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,9 +57,9 @@\n           (error, result) => {\n             if (error) reject(error);\n             else\n               resolve({\n-                url: result., //getPngUrl(result.public_id),\n+                url: result.secure_url, //getPngUrl(result.public_id),\n                 publicId: result.public_id,\n               });\n           }\n         );\n"
                }
            ],
            "date": 1769550561265,
            "name": "Commit-0",
            "content": "import dotenv from \"dotenv\";\nimport jwt from \"jsonwebtoken\";\nimport EmailEntry from \"../models/EmailEntry.js\";\nimport cloudinary, { cloudinaryUploadOptions } from \"../config/cloudinary.js\";\nimport Photo from \"../models/photo.js\";\nimport { extractColors } from \"../utils/extractColors.js\";\nimport { Readable } from \"stream\";\nimport { getPngUrl } from \"./cloudinaryUrls.js\";\n\ndotenv.config();\n\nexport const completeRegistration = async (req, res) => {\n  try {\n    const { email, name, age, country, story, year, title } = req.body;\n\n    if (!email) {\n      return res.status(400).json({ message: \"Falta el correo electrónico.\" });\n    }\n\n    if (!req.files || req.files.length === 0) {\n      return res\n        .status(400)\n        .json({ message: \"Debes subir al menos una fotografía.\" });\n    }\n\n    const parsedYear =\n      year === null || year === \"\" || year === undefined\n        ? undefined\n        : Number(year);\n    const currentYear = new Date().getFullYear();\n\n    if (\n      parsedYear !== undefined &&\n      (Number.isNaN(parsedYear) ||\n        parsedYear < 1882 ||\n        parsedYear > currentYear)\n    ) {\n      return res.status(400).json({ message: \"El año no es válido\" });\n    }\n\n    const normalizedCountry =\n      typeof country === \"string\" && country.trim()\n        ? country.trim().toUpperCase()\n        : \"\";\n\n    const existing = await EmailEntry.findOne({ email });\n    if (existing) {\n      return res\n        .status(400)\n        .json({ message: \"Este correo ya completó el registro.\" });\n    }\n\n    const uploadAsset = (file) =>\n      new Promise((resolve, reject) => {\n        const stream = cloudinary.uploader.upload_stream(\n          cloudinaryUploadOptions,\n          (error, result) => {\n            if (error) reject(error);\n            else\n              resolve({\n                url: result.imageUrl, //getPngUrl(result.public_id),\n                publicId: result.public_id,\n              });\n          }\n        );\n\n        const bufferStream = new Readable();\n        bufferStream.push(file.buffer);\n        bufferStream.push(null);\n        bufferStream.pipe(stream);\n      });\n\n    const uploadedAssets = await Promise.all(\n      req.files.map(async (file) => {\n        const colors = await extractColors(file.buffer, 1);\n        const asset = await uploadAsset(file);\n        return { ...asset, colors };\n      })\n    );\n    const uploadedUrls = uploadedAssets.map((asset) => asset.url);\n\n    const newUser = new EmailEntry({\n      email,\n      name,\n      age,\n      country: normalizedCountry,\n      story,\n      year: parsedYear,\n      photos: uploadedUrls,\n      subscribedAt: new Date(),\n    });\n\n    await newUser.save();\n\n    const normalizedTitle = title?.trim() || \"Fotografía del Proyecto Amarillo\";\n    const normalizedDescription = story?.trim() || \"\";\n    const normalizedYear = parsedYear;\n\n    const photoDocs = uploadedAssets.map((asset, index) => ({\n      title:\n        uploadedAssets.length > 1\n          ? `${normalizedTitle} #${index + 1}`\n          : normalizedTitle,\n      description: normalizedDescription,\n      owner: newUser._id,\n      imageUrl: asset.url,\n      publicId: asset.publicId,\n      year: normalizedYear,\n      country: normalizedCountry || null,\n      dominantColor: Array.isArray(asset.colors) ? asset.colors[0] : [],\n    }));\n\n    await Photo.insertMany(photoDocs);\n\n    const token = jwt.sign(\n      { userId: newUser._id.toString(), email: newUser.email },\n      process.env.JWT_SECRET,\n      { expiresIn: \"7d\" }\n    );\n\n    return res.status(200).json({\n      message: \"Registro completado con éxito.\",\n      colaboradorNum: await EmailEntry.countDocuments(),\n      token,\n      user: {\n        _id: newUser._id,\n        email: newUser.email,\n        name: newUser.name,\n        country: newUser.country,\n      },\n    });\n  } catch (error) {\n    console.error(\"❌ Error en completeRegistration:\", error);\n    return res.status(500).json({\n      message: \"Error interno del servidor.\",\n      error: error.message,\n    });\n  }\n};\n\nexport const getEmail = async (req, res) => {\n  try {\n    const users = await EmailEntry.find().lean();\n\n    const enriched = users.map((u) => ({\n      ...u,\n      photosCount: Array.isArray(u.photos) ? u.photos.length : 0,\n    }));\n\n    return res.status(200).json(enriched);\n  } catch (error) {\n    console.error(\"❌ Error en getEmail:\", error);\n    return res.status(500).json({\n      message: \"Error al obtener los registros.\",\n      error: error.message,\n    });\n  }\n};\n\nexport const deleteEmail = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const deleted = await EmailEntry.findByIdAndDelete(id);\n\n    if (!deleted) {\n      return res.status(404).json({ message: \"Correo no encontrado.\" });\n    }\n\n    return res.status(200).json({\n      message: \"Correo eliminado correctamente.\",\n      deleted,\n    });\n  } catch (error) {\n    console.error(\"❌ Error en deleteEmail:\", error);\n    return res.status(500).json({\n      message: \"Error al eliminar el correo.\",\n      error: error.message,\n    });\n  }\n};\n\nexport const updateEmailEntry = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { country } = req.body;\n\n    const user = await EmailEntry.findById(id);\n    if (!user) {\n      return res.status(404).json({ message: \"Usuario no encontrado.\" });\n    }\n\n    if (\n      !country ||\n      typeof country !== \"string\" ||\n      country.trim().length === 0\n    ) {\n      return res.status(400).json({ message: \"El país es obligatorio.\" });\n    }\n\n    const countryCode = country.trim().toUpperCase();\n    if (!/^[A-Z]{2}$/.test(countryCode)) {\n      return res\n        .status(400)\n        .json({ message: \"El país debe ser un código ISO de 2 letras.\" });\n    }\n\n    user.country = countryCode;\n    await user.save();\n\n    return res.status(200).json({\n      message: \"Usuario actualizado correctamente.\",\n      user,\n    });\n  } catch (error) {\n    console.error(\"❌ Error en updateEmailEntry:\", error);\n    return res.status(500).json({\n      message: \"Error al actualizar el usuario.\",\n      error: error.message,\n    });\n  }\n};\n\nexport const getUserPhotos = async (req, res) => {\n  try {\n    const { id } = req.params;\n    const user = await EmailEntry.findById(id).lean();\n\n    if (!user) {\n      return res.status(404).json({ message: \"Usuario no encontrado.\" });\n    }\n\n    let photos = await Photo.find({ owner: user._id }).lean();\n    if (!photos.length) {\n      photos = await Photo.find({ owner: user.email }).lean();\n    }\n\n    let formatted;\n    if (photos.length) {\n      formatted = photos.map((photo) => ({\n        _id: photo._id,\n        id: photo._id.toString(),\n        url: photo.imageUrl,\n        imageUrl: photo.imageUrl,\n        title: photo.title,\n        description: photo.description,\n        hidden: Boolean(photo.hidden),\n        likes: photo.likes,\n        createdAt: photo.createdAt,\n        country: photo.country ?? user.country ?? null,\n        dominantColor: photo.dominantColor || [],\n      }));\n    } else {\n      // Fallback legacy data\n      const legacyPhotos = Array.isArray(user.photos) ? user.photos : [];\n      const hiddenLegacy = Array.isArray(user.hiddenPhotos)\n        ? user.hiddenPhotos\n        : [];\n      formatted = legacyPhotos.map((url, index) => ({\n        _id: `${id}-${index}`,\n        id: `${id}-${index}`,\n        url,\n        imageUrl: url,\n        title: \"\",\n        description: \"\",\n        hidden: hiddenLegacy.includes(url),\n        likes: 0,\n        country: user.country ?? null,\n        dominantColor: [],\n      }));\n    }\n\n    return res.status(200).json({\n      email: user.email,\n      photos: formatted,\n    });\n  } catch (error) {\n    console.error(\"❌ Error al obtener fotos del usuario:\", error);\n    return res.status(500).json({\n      message: \"Error al obtener fotos del usuario.\",\n      error: error.message,\n    });\n  }\n};\n\nexport const getUserPhotosByEmail = async (req, res) => {\n  try {\n    const { email } = req.query;\n\n    if (!email) {\n      return res.status(400).json({ message: \"Email requerido\" });\n    }\n\n    const user = await EmailEntry.findOne({ email }).lean();\n\n    if (!user) {\n      return res.status(404).json({ message: \"Usuario no encontrado\" });\n    }\n\n    const photos = await Photo.find({ owner: user._id })\n      .select(\"imageUrl title description likes year country\")\n      .lean();\n\n    return res.status(200).json({\n      email: user.email,\n      name: user.name, // ✅ AQUÍ\n      photos, // ✅ likes incluidos\n    });\n  } catch (error) {\n    console.error(\"❌ Error getUserPhotosByEmail:\", error);\n    res.status(500).json({ message: \"Error interno\" });\n  }\n};\n"
        }
    ]
}